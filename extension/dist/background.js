(()=>{"use strict";const e="http://localhost:3000";function t(e,t){if(!t.focusModeEnabled)return!1;try{const o=new URL(e).hostname.replace("www.","");return!t.whitelist.some(e=>o.includes(e)||e.includes(o))&&t.blacklist.some(e=>o.includes(e)||e.includes(o))}catch(e){return!1}}chrome.runtime.onInstalled.addListener(()=>{console.log("LockIn extension installed"),chrome.storage.local.set({preferences:{focusModeEnabled:!0,whitelist:["stackoverflow.com","github.com","coursera.org"],blacklist:["instagram.com","tiktok.com","reddit.com","netflix.com"]},blockedToday:0,streak:0}),chrome.alarms.create("sync",{periodInMinutes:.5})}),chrome.alarms.onAlarm.addListener(t=>{"sync"===t.name&&async function(){try{const{syncToken:t}=await chrome.storage.local.get("syncToken");if(!t)return;const o=await fetch(`${e}/api/sync?token=${t}`);if(o.ok){const e=await o.json();await chrome.storage.local.set({preferences:{focusModeEnabled:e.focusModeEnabled,whitelist:e.whitelist,blacklist:e.blacklist,youtubeBlockedCategories:e.youtubeBlockedCategories||[],scheduleStart:e.scheduleStart,scheduleEnd:e.scheduleEnd}})}}catch(e){console.error("Sync error:",e)}}()}),chrome.webNavigation.onBeforeNavigate.addListener(async e=>{if(0!==e.frameId)return;const{preferences:o}=await chrome.storage.local.get("preferences");if(t(e.url,o)){chrome.tabs.update(e.tabId,{url:chrome.runtime.getURL("blocked.html")});const{blockedToday:t}=await chrome.storage.local.get("blockedToday");await chrome.storage.local.set({blockedToday:(t||0)+1})}}),chrome.runtime.onMessage.addListener((o,c,r)=>"GET_PREFERENCES"===o.type?(chrome.storage.local.get("preferences",e=>{r(e.preferences)}),!0):"UPDATE_PREFERENCES"===o.type?(chrome.storage.local.set({preferences:o.preferences},()=>{r({success:!0})}),!0):"CHECK_URL"===o.type?(chrome.storage.local.get("preferences",e=>{const c=t(o.url,e.preferences);r({shouldBlock:c})}),!0):"CLASSIFY_CONTENT"===o.type?(async function(t){try{const{syncToken:o}=await chrome.storage.local.get("syncToken");if(!o)return{error:"Not authenticated"};const c=await fetch(`${e}/api/classify-public`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({...t,syncToken:o})});return c.ok?await c.json():{error:"Classification failed"}}catch(e){return{error:"Classification failed"}}}(o.data).then(r),!0):void 0)})();